<!-- Imports -->
<script src="./node_modules/jquery/dist/jquery.js"></script>
<script src="./node_modules/vue/dist/vue.js"></script>
<script src="./node_modules/vue-autofocus-directive/dist/vue-autofocus-directive.js"></script>
<link rel="stylesheet" href="./wiki-crawl.css">

<!-- Template -->
<div id="map" @keydown.tab="expandLast">
    <transition-group name="list">
        <div class="topic"
             :key="i"
             v-for="(topic, i) in lineOfThought"
             :class="{expanded: expandedIndex == i}">
            <div class="inner">
            <h1  @click="toggleExpanded(i)">
                    <hr>
                    {{parseTitle(topic)}}
                </h1>
                <p v-if="expandedIndex != i" v-html="firstParagraph(topic)"></p>
                <p v-else v-html="bodyContent(topic)"></p>
            </div>

        </div>

        <div class="links" :key="'hello'" v-if="lineOfThought.length">
            <input v-focus v-model="input" ref="input" @keydown.enter="followSuggestion">
            <div class="suggestions">
                <a  v-for="sTopic in suggestions" @click="followLineOfThought(sTopic.href)">{{sTopic.title}}</a>
            </div>
        </div>
    </transition-group>
</div>



<script>
    new Vue({
        el: '#map',
        data: {
            lineOfThought: [],
            expandedIndex: null,
            input: '',
        },

        directives: {
            focus: {
                inserted (el) {
                    el.focus()
                }
            }
        },

        mounted() {
            this.followLineOfThought("/wiki/Art")
            var self = this
            $(document).on('click', '.topic a', function (e) {
                e.preventDefault()
                if ($(this).attr('href').includes('/wiki/'))
                    self.followLineOfThought($(this).attr('href'))
            })
        },

        computed: {
            lastTopic () {
                return this.lineOfThought[this.lineOfThought.length - 1]
            },

            suggestions () {
                return this.parseBodyLinks(this.lastTopic).filter(s =>
                    s.title.toLowerCase().includes(this.input.toLowerCase()))
            },
        },

        watch: {
            lineOfThought() {
                $('input').focus()
            }
        },



        methods: {
            $: jQuery,

            /**
             * Actions
             */
            expandLast() {
                this.expandedIndex = this.lineOfThought.length - 1
            },

            toggleExpanded(i) {
                if (this.expandedIndex == i)
                    this.expandedIndex = null
                else
                    this.expandedIndex = i
            },


            followSuggestion() {
                this.followLineOfThought(this.suggestions[0].href)
                this.input = ''
            },

            followLineOfThought (link) {
                $.get(`https://cors.io/?http://en.wikipedia.org/${link}`, data => {
                    this.lineOfThought.push(data)
                    setTimeout(() => $('input')[0].scrollIntoView({ behavior: 'smooth' }) , 1000)
                })
            },

            /**
             * Crawler
             */
            firstParagraph: html =>
                $(html).find('.mw-parser-output p:not(.mw-empty-elt, .hatnote)').first().html(),

            bodyContent: html =>
                $(html).find('#bodyContent').html(),

            parseTitle: html =>
               $(html).find('h1').text(),

             parseInfobox (html) {
                let info = {}
                for (let row of $(html).find('.infobox tr').get())
                    info[$(row).find('th').text()] = $(row).find('td').html()
                 return info
            },

            parseBodyLinks (html) {
                let links = []
                for (let link of $(html).find('p a[title]').get()) {
                    links.push({
                        title: $(link).text(),
                        href: $(link).attr('href')
                    })
                }
                return links
            }
        }
    })
</script>